# Example PR Validation Workflow
# Place this file in your service repository at: .github/workflows/pr-validation.yml

name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Trigger on changes to build configuration and Dockerfiles
      - '.ci/docker-matrix.json'
      - 'Dockerfile*'
    paths-ignore:
      # Don't trigger on documentation changes
      - '**.md'
      - 'docs/**'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Skip image push (dry run mode for testing)'
        required: false
        default: false
        type: boolean

# Required permissions for PR validation workflow
permissions:
  contents: read        # Checkout code, read docker-matrix.json
  pull-requests: write  # Comment on PR with test failures/scan results
  actions: read         # Read workflow artifacts from previous runs

jobs:
  validate:
    # Call the reusable workflow from build-workflow repository
    uses: runlix/build-workflow/.github/workflows/build-images-rebuild.yml@main
    with:
      pr_mode: true
      dry_run: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || false }}
    secrets: inherit

# Workflow behavior:
# - Validates docker-matrix.json schema
# - Builds all enabled variants Ã— platforms in parallel (local Docker daemon only)
# - Runs test scripts for each variant (if configured)
# - Scans images for vulnerabilities with Trivy
# - Comments on PR with build and test results
# - **NOTE**: Images are NOT pushed to registry in PR mode
# - Blocks merge if builds, tests, or critical vulnerabilities fail
