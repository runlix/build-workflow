name: 'Check PR Images Exist'
description: |
  Checks if PR images exist in GitHub Container Registry (GHCR) by verifying all target images.
  
  This action checks all targets in the matrix to ensure all PR images exist. The image tag format is:
  ghcr.io/{repository}:pr-{branch}-{version}-{target}-{sha}

inputs:
  repository:
    description: 'GitHub repository in owner/repo format (e.g., runlix/radarr)'
    required: true
  branch:
    description: 'Branch name (will be sanitized: slashes replaced with hyphens)'
    required: true
  version:
    description: 'Version string from VERSION.json'
    required: true
  pr_head_sha_short:
    description: 'PR head commit SHA shortened to 7 hex characters (e.g., 9e4b4f2)'
    required: true
  matrix:
    description: 'YAML array of build targets (from VERSION.json). All targets are checked to ensure all PR images exist.'
    required: true

outputs:
  pr_images_found:
    description: 'true if all PR images exist for all targets, false otherwise'
    value: ${{ steps.check.outputs.pr_images_found }}

runs:
  using: 'composite'
  steps:
    - name: Write matrix to file
      shell: bash
      env:
        MATRIX_JSON: ${{ toJson(fromJson(inputs.matrix)) }}
      run: |
        # Write matrix input to file using environment variable to avoid shell command line truncation
        # Environment variables can handle larger content than command line arguments
        # Use jq to validate and compact the JSON while writing to file
        MATRIX_TMPFILE=$(mktemp)
        if [ -z "${MATRIX_JSON}" ] || [ "${MATRIX_JSON}" = "null" ]; then
          rm -f "${MATRIX_TMPFILE}"
          echo "::error::[VALIDATION_001] check-pr-images-exist: matrix is required" >&2
          exit 1
        fi
        # Use jq to parse and compact, reading from environment variable via stdin
        printf '%s' "${MATRIX_JSON}" | jq -c . > "${MATRIX_TMPFILE}" 2>/dev/null || {
          rm -f "${MATRIX_TMPFILE}"
          echo "::error::[VALIDATION_004] check-pr-images-exist: matrix must be valid JSON" >&2
          exit 1
        }
        echo "MATRIX_TMPFILE=${MATRIX_TMPFILE}" >> "$GITHUB_ENV"
    
    - name: Validate inputs
      shell: bash
      run: |
        set -e
        set -o pipefail
        
        readonly ACTION_NAME="check-pr-images-exist"
        
        # Helper function: Validate required input
        validate_required() {
          local name="$1"
          local value="$2"
          if [ -z "${value}" ] || [ "${value}" = "null" ]; then
            echo "::error::[VALIDATION_001] ${ACTION_NAME}: ${name} is required" >&2
            exit 1
          fi
        }
        
        # Helper function: Validate repository format
        validate_repository() {
          local repo="$1"
          if ! [[ "${repo}" =~ ^[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+$ ]]; then
            echo "::error::[VALIDATION_002] ${ACTION_NAME}: Invalid repository format (expected: owner/repo, got: ${repo})" >&2
            exit 1
          fi
        }
        
        # Helper function: Validate SHA format
        validate_sha() {
          local sha="$1"
          if ! [[ "${sha}" =~ ^[a-f0-9]{7}$ ]]; then
            echo "::error::[VALIDATION_003] ${ACTION_NAME}: Invalid pr_head_sha_short format (expected: 7 lowercase hex characters, got: ${sha})" >&2
            exit 1
          fi
        }
        
        # Extract inputs
        REPOSITORY_INPUT="${{ inputs.repository }}"
        BRANCH_INPUT="${{ inputs.branch }}"
        VERSION_INPUT="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT_INPUT="${{ inputs.pr_head_sha_short }}"
        
        # Validate all inputs
        validate_required "repository" "${REPOSITORY_INPUT}"
        validate_required "branch" "${BRANCH_INPUT}"
        validate_required "version" "${VERSION_INPUT}"
        validate_required "pr_head_sha_short" "${PR_HEAD_SHA_SHORT_INPUT}"
        
        validate_repository "${REPOSITORY_INPUT}"
        validate_sha "${PR_HEAD_SHA_SHORT_INPUT}"
        
        # Validate matrix: use jq exclusively for JSON validation
        # Matrix was written to file in previous step to avoid shell variable truncation
        # Read from file instead of shell variable to handle large JSON
        MATRIX_TMPFILE="${MATRIX_TMPFILE}"
        if [ ! -f "${MATRIX_TMPFILE}" ]; then
          echo "::error::[VALIDATION_006] ${ACTION_NAME}: Matrix temp file not found" >&2
          exit 1
        fi
        
        # Check for empty input (file size check)
        if [ ! -s "${MATRIX_TMPFILE}" ]; then
          rm -f "${MATRIX_TMPFILE}"
          echo "::error::[VALIDATION_001] ${ACTION_NAME}: matrix is required" >&2
          exit 1
        fi
        
        # Parse and compact JSON using jq -c (compact format, single line)
        # jq handles multiline EOF format correctly, so we can parse multiline JSON directly
        # Read from file instead of shell variable to avoid truncation
        if ! jq -c . < "${MATRIX_TMPFILE}" > "${MATRIX_TMPFILE}.compact" 2>/dev/null; then
          rm -f "${MATRIX_TMPFILE}" "${MATRIX_TMPFILE}.compact"
          echo "::error::[VALIDATION_004] ${ACTION_NAME}: matrix must be valid JSON" >&2
          exit 1
        fi
        
        # Replace original with compact version
        mv "${MATRIX_TMPFILE}.compact" "${MATRIX_TMPFILE}"
        
        # Validate matrix is a non-empty array
        if ! jq -e 'type == "array" and length > 0' < "${MATRIX_TMPFILE}" >/dev/null 2>&1; then
          rm -f "${MATRIX_TMPFILE}"
          echo "::error::[VALIDATION_005] ${ACTION_NAME}: matrix must be a non-empty JSON array" >&2
          exit 1
        fi
    
    - name: Check if PR images exist
      id: check
      shell: bash
      run: |
        set -e
        
        readonly ACTION_NAME="check-pr-images-exist"
        
        # Helper function: Sanitize branch name for Docker tag compatibility
        sanitize_branch() {
          local branch="$1"
          echo "${branch//\//-}"
        }
        
        # Helper function: Construct PR image tag
        construct_image_tag() {
          local repository="$1"
          local branch_sanitized="$2"
          local version="$3"
          local target_name="$4"
          local sha_short="$5"
          echo "ghcr.io/${repository}:pr-${branch_sanitized}-${version}-${target_name}-${sha_short}"
        }
        
        # Helper function: Check if image exists in GHCR
        image_exists() {
          local image_tag="$1"
          docker buildx imagetools inspect "${image_tag}" >/dev/null 2>&1
        }
        
        # Extract inputs
        REPOSITORY="${{ inputs.repository }}"
        BRANCH="${{ inputs.branch }}"
        VERSION="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT="${{ inputs.pr_head_sha_short }}"
        
        # Matrix was normalized and validated in previous step, reuse temp file
        MATRIX_TMPFILE="${MATRIX_TMPFILE}"
        if [ ! -f "${MATRIX_TMPFILE}" ]; then
          echo "::error::[VALIDATION_006] ${ACTION_NAME}: Matrix temp file not found" >&2
          exit 1
        fi
        
        # Clean up temp file on exit
        trap "rm -f ${MATRIX_TMPFILE}" EXIT
        
        # Sanitize branch name
        BRANCH_SANITIZED=$(sanitize_branch "${BRANCH}")
        
        # Get all target names from matrix using the temp file (already validated)
        TARGET_NAMES=$(jq -r '.[].name' < "${MATRIX_TMPFILE}")
        TARGET_COUNT=$(jq 'length' < "${MATRIX_TMPFILE}")
        
        echo "ðŸ” Checking ${TARGET_COUNT} PR image(s)..."
        
        # Check each target image
        ALL_FOUND=true
        MISSING_TARGETS=()
        
        while IFS= read -r target_name; do
          if [ -z "${target_name}" ]; then
            continue
          fi
          
          IMAGE_TAG=$(construct_image_tag "${REPOSITORY}" "${BRANCH_SANITIZED}" "${VERSION}" "${target_name}" "${PR_HEAD_SHA_SHORT}")
          
          if image_exists "${IMAGE_TAG}"; then
            echo "âœ… Found PR image: ${IMAGE_TAG}"
          else
            echo "âŒ PR image not found: ${IMAGE_TAG}"
            ALL_FOUND=false
            MISSING_TARGETS+=("${target_name}")
          fi
        done <<< "${TARGET_NAMES}"
        
        # Set output based on whether all images were found
        if [ "${ALL_FOUND}" = "true" ]; then
          PR_IMAGES_FOUND="true"
          echo ""
          echo "ðŸ“Š Result: All ${TARGET_COUNT} PR image(s) found âœ…"
        else
          PR_IMAGES_FOUND="false"
          echo ""
          echo "ðŸ“Š Result: Missing ${#MISSING_TARGETS[@]} PR image(s): ${MISSING_TARGETS[*]} âŒ"
        fi
        
        echo "pr_images_found=${PR_IMAGES_FOUND}" >> "$GITHUB_OUTPUT"
