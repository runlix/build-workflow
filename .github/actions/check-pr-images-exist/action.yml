name: 'Check PR Images Exist'
description: |
  Checks if PR images exist in GitHub Container Registry (GHCR) by verifying the first target image.
  
  This action is used as an optimization: PR images are built for all targets together, so checking
  the first target is sufficient to determine if all PR images exist. The image tag format is:
  ghcr.io/{repository}:pr-{branch}-{version}-{target}-{sha}

inputs:
  repository:
    description: 'GitHub repository in owner/repo format (e.g., runlix/radarr)'
    required: true
  branch:
    description: 'Branch name (will be sanitized: slashes replaced with hyphens)'
    required: true
  version:
    description: 'Version string from VERSION.json'
    required: true
  pr_head_sha_short:
    description: 'PR head commit SHA shortened to 7 hex characters (e.g., 9e4b4f2)'
    required: true
  matrix:
    description: 'JSON array of build targets (from VERSION.json). Only the first target is checked as an optimization - if it exists, we assume all PR images exist.'
    required: true

outputs:
  pr_images_found:
    description: 'true if PR image exists for the first target, false otherwise'
    value: ${{ steps.check.outputs.pr_images_found }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        set -e
        set -o pipefail
        
        # Constants
        readonly ACTION_NAME="check-pr-images-exist"
        
        # ============================================================================
        # Extract Inputs to Variables
        # ============================================================================
        # Store inputs in variables first to avoid shell parsing issues with complex values
        REPOSITORY_INPUT="${{ inputs.repository }}"
        BRANCH_INPUT="${{ inputs.branch }}"
        VERSION_INPUT="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT_INPUT="${{ inputs.pr_head_sha_short }}"
        
        # ============================================================================
        # Input Validation
        # ============================================================================
        
        # Validate required inputs (using variables to avoid shell parsing issues with complex values)
        # Check for empty or null values
        if [ -z "${REPOSITORY_INPUT}" ] || [ "${REPOSITORY_INPUT}" = "null" ]; then
          echo "::error::[VALIDATION_001] ${ACTION_NAME}: repository is required" >&2
          exit 1
        fi
        
        if [ -z "${BRANCH_INPUT}" ] || [ "${BRANCH_INPUT}" = "null" ]; then
          echo "::error::[VALIDATION_001] ${ACTION_NAME}: branch is required" >&2
          exit 1
        fi
        
        if [ -z "${VERSION_INPUT}" ] || [ "${VERSION_INPUT}" = "null" ]; then
          echo "::error::[VALIDATION_001] ${ACTION_NAME}: version is required" >&2
          exit 1
        fi
        
        if [ -z "${PR_HEAD_SHA_SHORT_INPUT}" ] || [ "${PR_HEAD_SHA_SHORT_INPUT}" = "null" ]; then
          echo "::error::[VALIDATION_001] ${ACTION_NAME}: pr_head_sha_short is required" >&2
          exit 1
        fi
        
        # Validate repository format (must be owner/repo)
        if ! [[ "${REPOSITORY_INPUT}" =~ ^[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+$ ]]; then
          echo "::error::[VALIDATION_002] ${ACTION_NAME}: Invalid repository format (expected: owner/repo, got: ${REPOSITORY_INPUT})" >&2
          exit 1
        fi
        
        # Validate SHA format (exactly 7 lowercase hex characters)
        if ! [[ "${PR_HEAD_SHA_SHORT_INPUT}" =~ ^[a-f0-9]{7}$ ]]; then
          echo "::error::[VALIDATION_003] ${ACTION_NAME}: Invalid pr_head_sha_short format (expected: 7 lowercase hex characters, got: ${PR_HEAD_SHA_SHORT_INPUT})" >&2
          exit 1
        fi
        
        # Validate matrix: use jq with stdin to avoid shell interpretation
        # Write JSON to temp file using printf, then read from stdin
        # This avoids shell quote interpretation by using file I/O
        MATRIX_TMP_FILE=$(mktemp)
        DEBUG_LOG="/Users/ohayoun/personal/runlix/.cursor/debug.log"
        
        # Debug: Log before printf
        echo "{\"id\":\"log_$(date +%s)_1\",\"timestamp\":$(date +%s)000,\"location\":\"action.yml:96\",\"message\":\"Before printf - temp file path\",\"data\":{\"temp_file\":\"${MATRIX_TMP_FILE}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A\"}" >> "${DEBUG_LOG}"
        
        # Write the GitHub Actions expanded JSON to file using printf
        # printf '%s\n' with double quotes allows expansion, printf handles the string correctly
        printf '%s\n' "${{ inputs.matrix }}" > "${MATRIX_TMP_FILE}" 2>&1
        PRINTF_EXIT=$?
        
        # Debug: Log after printf
        FILE_SIZE=$(wc -c < "${MATRIX_TMP_FILE}" 2>/dev/null || echo "0")
        FILE_CONTENT_PREVIEW=$(head -c 200 < "${MATRIX_TMP_FILE}" 2>/dev/null || echo "ERROR_READING")
        echo "{\"id\":\"log_$(date +%s)_2\",\"timestamp\":$(date +%s)000,\"location\":\"action.yml:100\",\"message\":\"After printf - file write result\",\"data\":{\"printf_exit\":${PRINTF_EXIT},\"file_size\":${FILE_SIZE},\"content_preview\":\"${FILE_CONTENT_PREVIEW}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"B\"}" >> "${DEBUG_LOG}"
        
        # Debug: Log file content check
        if [ ! -s "${MATRIX_TMP_FILE}" ]; then
          echo "{\"id\":\"log_$(date +%s)_3\",\"timestamp\":$(date +%s)000,\"location\":\"action.yml:103\",\"message\":\"File is empty or missing\",\"data\":{\"file_exists\":$([ -f "${MATRIX_TMP_FILE}" ] && echo "true" || echo "false\")},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\"}" >> "${DEBUG_LOG}"
        fi
        
        # Debug: Log jq validation attempt
        JQ_VALIDATE_OUTPUT=$(jq -e 'type == "array" and length > 0' < "${MATRIX_TMP_FILE}" 2>&1)
        JQ_VALIDATE_EXIT=$?
        JQ_EMPTY_OUTPUT=$(jq empty < "${MATRIX_TMP_FILE}" 2>&1)
        JQ_EMPTY_EXIT=$?
        echo "{\"id\":\"log_$(date +%s)_4\",\"timestamp\":$(date +%s)000,\"location\":\"action.yml:109\",\"message\":\"jq validation results\",\"data\":{\"validate_exit\":${JQ_VALIDATE_EXIT},\"validate_output\":\"${JQ_VALIDATE_OUTPUT}\",\"empty_exit\":${JQ_EMPTY_EXIT},\"empty_output\":\"${JQ_EMPTY_OUTPUT}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"D\"}" >> "${DEBUG_LOG}"
        
        # Validate matrix is valid JSON and a non-empty array from the file
        if ! jq -e 'type == "array" and length > 0' < "${MATRIX_TMP_FILE}" >/dev/null 2>&1; then
          if ! jq empty < "${MATRIX_TMP_FILE}" >/dev/null 2>&1; then
            echo "::error::[VALIDATION_004] ${ACTION_NAME}: matrix must be valid JSON" >&2
          else
            echo "::error::[VALIDATION_005] ${ACTION_NAME}: matrix must be a non-empty JSON array" >&2
          fi
          rm -f "${MATRIX_TMP_FILE}"
          exit 1
        fi
        rm -f "${MATRIX_TMP_FILE}"
    
    - name: Check if PR images exist
      id: check
      shell: bash
      run: |
        set -e
        
        # ============================================================================
        # Extract and Prepare Inputs
        # ============================================================================
        
        REPOSITORY="${{ inputs.repository }}"
        BRANCH="${{ inputs.branch }}"
        VERSION="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT="${{ inputs.pr_head_sha_short }}"
        
        # Sanitize branch name: replace slashes with hyphens for Docker tag compatibility
        # Example: "feature/new-ui" -> "feature-new-ui"
        BRANCH_SANITIZED="${BRANCH//\//-}"
        
        # ============================================================================
        # Extract First Target from Matrix
        # ============================================================================
        
        # Extract the first target name from the matrix
        # Optimization: We only check the first target because:
        # - PR images are built for all targets together in a single workflow run
        # - If the first target exists, all targets should exist
        # Write JSON to temp file using printf, then read from file to avoid shell quoting issues
        MATRIX_TMP_FILE=$(mktemp)
        printf '%s\n' "${{ inputs.matrix }}" > "${MATRIX_TMP_FILE}"
        FIRST_TARGET_NAME=$(jq -r '.[0].name // empty' < "${MATRIX_TMP_FILE}" 2>/dev/null || echo "")
        rm -f "${MATRIX_TMP_FILE}"
        
        if [ -z "${FIRST_TARGET_NAME}" ]; then
          echo "âš ï¸  No target name found in first matrix entry"
          PR_IMAGES_FOUND="false"
        else
          # ============================================================================
          # Construct Image Tag and Check Existence
          # ============================================================================
          
          # Construct PR image tag following the format:
          # ghcr.io/{repository}:pr-{branch}-{version}-{target}-{sha}
          # Example: ghcr.io/runlix/radarr:pr-release-4.0.16.2944-amd64-latest-9e4b4f2
          PR_IMAGE_TAG="ghcr.io/${REPOSITORY}:pr-${BRANCH_SANITIZED}-${VERSION}-${FIRST_TARGET_NAME}-${PR_HEAD_SHA_SHORT}"
          
          echo "ðŸ” Checking for PR image: ${PR_IMAGE_TAG}"
          
          # Use docker buildx imagetools to check if image exists in GHCR
          # Suppress output (redirect to /dev/null) and check exit code
          if docker buildx imagetools inspect "${PR_IMAGE_TAG}" >/dev/null 2>&1; then
            echo "âœ… Found PR image: ${PR_IMAGE_TAG}"
            PR_IMAGES_FOUND="true"
          else
            echo "âŒ PR image not found: ${PR_IMAGE_TAG}"
            PR_IMAGES_FOUND="false"
          fi
        fi
        
        # ============================================================================
        # Set Output
        # ============================================================================
        
        echo "pr_images_found=${PR_IMAGES_FOUND}" >> $GITHUB_OUTPUT
        echo ""
        echo "ðŸ“Š Result: PR images found = ${PR_IMAGES_FOUND}"
