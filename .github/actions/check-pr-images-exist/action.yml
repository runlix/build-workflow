name: 'Check PR Images Exist'
description: |
  Checks if PR images exist in GitHub Container Registry (GHCR) by verifying all target images.
  
  This action checks all targets in the matrix to ensure all PR images exist. The image tag format is:
  ghcr.io/{repository}:pr-{branch}-{version}-{target}-{sha}

inputs:
  repository:
    description: 'GitHub repository in owner/repo format (e.g., runlix/radarr)'
    required: true
  branch:
    description: 'Branch name (will be sanitized: slashes replaced with hyphens)'
    required: true
  version:
    description: 'Version string from VERSION.json'
    required: true
  pr_head_sha_short:
    description: 'PR head commit SHA shortened to 7 hex characters (e.g., 9e4b4f2)'
    required: true
  matrix:
    description: 'JSON array of build targets (from VERSION.json). All targets are checked to ensure all PR images exist.'
    required: true

outputs:
  pr_images_found:
    description: 'true if all PR images exist for all targets, false otherwise'
    value: ${{ steps.check.outputs.pr_images_found }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        set -e
        set -o pipefail
        
        readonly ACTION_NAME="check-pr-images-exist"
        
        # Helper function: Validate required input
        validate_required() {
          local name="$1"
          local value="$2"
          if [ -z "${value}" ] || [ "${value}" = "null" ]; then
            echo "::error::[VALIDATION_001] ${ACTION_NAME}: ${name} is required" >&2
            exit 1
          fi
        }
        
        # Helper function: Validate repository format
        validate_repository() {
          local repo="$1"
          if ! [[ "${repo}" =~ ^[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+$ ]]; then
            echo "::error::[VALIDATION_002] ${ACTION_NAME}: Invalid repository format (expected: owner/repo, got: ${repo})" >&2
            exit 1
          fi
        }
        
        # Helper function: Validate SHA format
        validate_sha() {
          local sha="$1"
          if ! [[ "${sha}" =~ ^[a-f0-9]{7}$ ]]; then
            echo "::error::[VALIDATION_003] ${ACTION_NAME}: Invalid pr_head_sha_short format (expected: 7 lowercase hex characters, got: ${sha})" >&2
            exit 1
          fi
        }
        
        # Helper function: Validate and normalize matrix JSON
        validate_matrix() {
          local matrix_input="$1"
          local tmp_file
          tmp_file=$(mktemp)
          printf '%s\n' "${matrix_input}" > "${tmp_file}"
          
          # Check if it's valid JSON
          if ! jq empty "${tmp_file}" >/dev/null 2>&1; then
            rm -f "${tmp_file}"
            echo "::error::[VALIDATION_004] ${ACTION_NAME}: matrix must be valid JSON" >&2
            exit 1
          fi
          
          # Check if it's a non-empty array
          if ! jq -e 'type == "array" and length > 0' "${tmp_file}" >/dev/null 2>&1; then
            rm -f "${tmp_file}"
            echo "::error::[VALIDATION_005] ${ACTION_NAME}: matrix must be a non-empty JSON array" >&2
            exit 1
          fi
          
          # Return normalized JSON
          jq -c '.' "${tmp_file}"
          rm -f "${tmp_file}"
        }
        
        # Extract inputs
        REPOSITORY_INPUT="${{ inputs.repository }}"
        BRANCH_INPUT="${{ inputs.branch }}"
        VERSION_INPUT="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT_INPUT="${{ inputs.pr_head_sha_short }}"
        MATRIX_INPUT="${{ inputs.matrix }}"
        
        # Validate all inputs
        validate_required "repository" "${REPOSITORY_INPUT}"
        validate_required "branch" "${BRANCH_INPUT}"
        validate_required "version" "${VERSION_INPUT}"
        validate_required "pr_head_sha_short" "${PR_HEAD_SHA_SHORT_INPUT}"
        validate_required "matrix" "${MATRIX_INPUT}"
        
        validate_repository "${REPOSITORY_INPUT}"
        validate_sha "${PR_HEAD_SHA_SHORT_INPUT}"
        
        # Validate matrix (normalization happens in check step)
        validate_matrix "${MATRIX_INPUT}" >/dev/null
    
    - name: Check if PR images exist
      id: check
      shell: bash
      run: |
        set -e
        
        readonly ACTION_NAME="check-pr-images-exist"
        
        # Helper function: Read JSON input safely using temp file
        read_json_input() {
          local input_value="$1"
          local tmp_file
          tmp_file=$(mktemp)
          printf '%s\n' "${input_value}" > "${tmp_file}"
          local result
          result=$(jq -c '.' "${tmp_file}" 2>/dev/null) || {
            rm -f "${tmp_file}"
            return 1
          }
          rm -f "${tmp_file}"
          echo "${result}"
        }
        
        # Helper function: Sanitize branch name for Docker tag compatibility
        sanitize_branch() {
          local branch="$1"
          echo "${branch//\//-}"
        }
        
        # Helper function: Construct PR image tag
        construct_image_tag() {
          local repository="$1"
          local branch_sanitized="$2"
          local version="$3"
          local target_name="$4"
          local sha_short="$5"
          echo "ghcr.io/${repository}:pr-${branch_sanitized}-${version}-${target_name}-${sha_short}"
        }
        
        # Helper function: Check if image exists in GHCR
        image_exists() {
          local image_tag="$1"
          docker buildx imagetools inspect "${image_tag}" >/dev/null 2>&1
        }
        
        # Extract inputs
        REPOSITORY="${{ inputs.repository }}"
        BRANCH="${{ inputs.branch }}"
        VERSION="${{ inputs.version }}"
        PR_HEAD_SHA_SHORT="${{ inputs.pr_head_sha_short }}"
        
        # Read and parse matrix using helper function
        MATRIX=$(read_json_input '${{ inputs.matrix }}')
        
        # Sanitize branch name
        BRANCH_SANITIZED=$(sanitize_branch "${BRANCH}")
        
        # Get all target names from matrix
        TARGET_NAMES=$(jq -r '.[].name' <<< "${MATRIX}")
        TARGET_COUNT=$(jq 'length' <<< "${MATRIX}")
        
        echo "ðŸ” Checking ${TARGET_COUNT} PR image(s)..."
        
        # Check each target image
        ALL_FOUND=true
        MISSING_TARGETS=()
        
        while IFS= read -r target_name; do
          if [ -z "${target_name}" ]; then
            continue
          fi
          
          IMAGE_TAG=$(construct_image_tag "${REPOSITORY}" "${BRANCH_SANITIZED}" "${VERSION}" "${target_name}" "${PR_HEAD_SHA_SHORT}")
          
          if image_exists "${IMAGE_TAG}"; then
            echo "âœ… Found PR image: ${IMAGE_TAG}"
          else
            echo "âŒ PR image not found: ${IMAGE_TAG}"
            ALL_FOUND=false
            MISSING_TARGETS+=("${target_name}")
          fi
        done <<< "${TARGET_NAMES}"
        
        # Set output based on whether all images were found
        if [ "${ALL_FOUND}" = "true" ]; then
          PR_IMAGES_FOUND="true"
          echo ""
          echo "ðŸ“Š Result: All ${TARGET_COUNT} PR image(s) found âœ…"
        else
          PR_IMAGES_FOUND="false"
          echo ""
          echo "ðŸ“Š Result: Missing ${#MISSING_TARGETS[@]} PR image(s): ${MISSING_TARGETS[*]} âŒ"
        fi
        
        echo "pr_images_found=${PR_IMAGES_FOUND}" >> "$GITHUB_OUTPUT"
