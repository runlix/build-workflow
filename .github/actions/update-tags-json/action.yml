name: 'Update Tags JSON'
description: 'Update tags.json file with new build tags and commit changes'

inputs:
  run_id:
    description: 'GitHub Actions run ID'
    required: true
  repository:
    description: 'GitHub repository (e.g., owner/repo)'
    required: true
  server_url:
    description: 'GitHub server URL'
    required: true
  branch:
    description: 'Branch name'
    required: true
  version:
    description: 'Version string'
    required: true
  sha:
    description: 'Git commit SHA'
    required: true
  variants:
    description: 'Multiline string of variants'
    required: true
  app_id:
    description: 'GitHub App ID'
    required: true
  private_key:
    description: 'GitHub App private key'
    required: true
  owner:
    description: 'Repository owner (organization or user)'
    required: true

outputs:
  pr_created:
    description: 'Whether a PR was created (true/false)'
    value: ${{ steps.create-pr.outputs.pr_created }}
  pr_number:
    description: 'PR number if created, empty otherwise'
    value: ${{ steps.create-pr.outputs.pr_number }}
  pr_branch:
    description: 'Branch name used for PR, empty if no PR created'
    value: ${{ steps.create-pr.outputs.pr_branch }}
  merged:
    description: 'Whether the PR was merged (true/false)'
    value: ${{ steps.auto-merge.outputs.merged }}
  branch_deleted:
    description: 'Whether the PR branch was deleted (true/false)'
    value: ${{ steps.delete-branch.outputs.deleted }}

runs:
  using: 'composite'
  steps:
    - name: Generate GitHub App Token
      id: app-token
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ inputs.app_id }}
        private-key: ${{ inputs.private_key }}
        owner: ${{ inputs.owner }}

    - name: Get GitHub App Bot User ID
      id: get-user-id
      shell: bash
      run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Update tags.json and create PR
      id: create-pr
      shell: bash
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
        APP_BOT_NAME: ${{ steps.app-token.outputs.app-slug }}[bot]
        APP_BOT_EMAIL: ${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com
      run: |
        set -e
        
        RUN_ID="${{ inputs.run_id }}"
        REPOSITORY="${{ inputs.repository }}"
        SERVER_URL="${{ inputs.server_url }}"
        BRANCH="${{ inputs.branch }}"
        VERSION="${{ inputs.version }}"
        SHA="${{ inputs.sha }}"
        VARIANTS="${{ inputs.variants }}"
        
        # Configure git to use GitHub App token for authentication
        git config --global credential.helper store
        echo "https://${APP_BOT_NAME}:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
        
        # Retry function for git operations
        retry_git_operation() {
          local max_attempts=3
          local attempt=1
          local wait_seconds=30
          
          while [ $attempt -le $max_attempts ]; do
            if [ $attempt -gt 1 ]; then
              echo "Retry attempt $attempt of $max_attempts (waiting ${wait_seconds}s)..."
              sleep $wait_seconds
              git pull --rebase || true
            fi
            
            if "$@"; then
              return 0
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "Failed after $max_attempts attempts"
          return 1
        }
        
        # Pull latest changes to handle concurrent updates
        git pull --rebase || true
        
        # Create tags.json if it doesn't exist
        [ ! -f tags.json ] && echo '{}' > tags.json
        
        # Generate timestamp
        TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')
        BUILD_URL="${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID}"
        
        # Sanitize branch name: replace '/' with '-' for valid Docker tag (matching publish job)
        BRANCH_SANITIZED="${BRANCH//\//-}"
        
        # Update tags.json for each variant (matching publish job tag format)
        echo "$VARIANTS" | while IFS= read -r variant; do
          # Create tags matching publish job format: branch-variant, branch-version-variant, branch-sha-variant
          TAG_BRANCH_VARIANT="${BRANCH_SANITIZED}-${variant}"
          TAG_BRANCH_VERSION_VARIANT="${BRANCH_SANITIZED}-${VERSION}-${variant}"
          TAG_BRANCH_SHA_VARIANT="${BRANCH_SANITIZED}-${SHA:0:7}-${variant}"
          
          # Update tags.json using jq (same structure as publish job creates)
          jq --sort-keys \
              --arg branch_variant "${TAG_BRANCH_VARIANT}" \
              --arg tag_branch_variant "${TAG_BRANCH_VARIANT}" \
              --arg tag_branch_version_variant "${TAG_BRANCH_VERSION_VARIANT}" \
              --arg tag_branch_sha_variant "${TAG_BRANCH_SHA_VARIANT}" \
              --arg last_updated "${TIMESTAMP}" \
              --arg last_updated_url "${BUILD_URL}" \
              --arg description "${TAG_BRANCH_VARIANT}" \
              --argjson hide false \
              '.[$branch_variant] = {
                "description": $description,
                "hide": $hide,
                "last_updated": $last_updated,
                "last_updated_url": $last_updated_url,
                "tags": [$tag_branch_variant, $tag_branch_version_variant, $tag_branch_sha_variant]
              }' tags.json > tags.json.tmp && mv tags.json.tmp tags.json
        done
        
        # Initialize outputs to defaults
        echo "pr_created=false" >> $GITHUB_OUTPUT
        echo "pr_number=" >> $GITHUB_OUTPUT
        echo "pr_branch=" >> $GITHUB_OUTPUT
        
        # Only commit if tags.json actually changed
        if ! git diff --quiet tags.json; then
          git config user.name "${APP_BOT_NAME}"
          git config user.email "${APP_BOT_EMAIL}"
          git add tags.json
          git commit -m "Update tags.json for ${BRANCH} branch variants (version: ${VERSION}) [skip ci]" || exit 0
          
          # Create a unique branch for the PR
          BRANCH_TIMESTAMP=$(date +%s)
          PR_BRANCH="update-tags-json-${VERSION}-${BRANCH_TIMESTAMP}"
          
          echo "Creating branch: ${PR_BRANCH}"
          git checkout -b "${PR_BRANCH}" || { echo "Error: Failed to create branch"; exit 1; }
          
          # Push to the new branch
          echo "Pushing to branch: ${PR_BRANCH}"
          retry_git_operation git push -u origin "${PR_BRANCH}" || { echo "Error: Failed to push branch"; exit 1; }
          
          # Create PR
          PR_TITLE="update-tags-json-${BRANCH}-${VERSION}"
          PR_BODY="Automatically update tags.json for ${BRANCH} branch variants (version: ${VERSION})"
          
          echo "Creating PR: ${PR_TITLE}"
          # #region agent log
          echo "{\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A\",\"location\":\"update-tags-json/action.yml:184\",\"message\":\"Before PR creation\",\"data\":{\"title\":\"${PR_TITLE}\",\"base\":\"${BRANCH}\",\"head\":\"${PR_BRANCH}\"},\"timestamp\":$(date +%s)000}"
          # #endregion
          
          # Use gh api to create PR and get number from JSON response
          PR_RESPONSE=$(gh api repos/${REPOSITORY}/pulls \
            --method POST \
            -f title="${PR_TITLE}" \
            -f body="${PR_BODY}" \
            -f base="${BRANCH}" \
            -f head="${PR_BRANCH}" \
            2>&1)
          
          # #region agent log
          echo "{\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\",\"location\":\"update-tags-json/action.yml:195\",\"message\":\"PR creation response\",\"data\":{\"response\":\"${PR_RESPONSE}\"},\"timestamp\":$(date +%s)000}"
          # #endregion
          
          # Extract PR number from JSON response
          PR_NUMBER=$(echo "${PR_RESPONSE}" | jq -r '.number // empty' 2>/dev/null || echo "")
          
          # #region agent log
          echo "{\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\",\"location\":\"update-tags-json/action.yml:200\",\"message\":\"Extracted PR number\",\"data\":{\"pr_number\":\"${PR_NUMBER}\"},\"timestamp\":$(date +%s)000}"
          # #endregion
          
          if [ -z "${PR_NUMBER}" ] || [[ "${PR_NUMBER}" =~ ^[^0-9] ]] || [ "${PR_NUMBER}" = "null" ]; then
            echo "Failed to create PR. Response: ${PR_RESPONSE}"
            # #region agent log
            echo "{\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A\",\"location\":\"update-tags-json/action.yml:205\",\"message\":\"PR creation failed\",\"data\":{\"pr_number\":\"${PR_NUMBER}\",\"response\":\"${PR_RESPONSE}\"},\"timestamp\":$(date +%s)000}"
            # #endregion
            echo "pr_created=false" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "pr_branch=" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "Created PR #${PR_NUMBER}"
          echo "pr_created=true" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_branch=${PR_BRANCH}" >> $GITHUB_OUTPUT
        else
          echo "No changes to tags.json, skipping commit"
          echo "pr_created=false" >> $GITHUB_OUTPUT
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "pr_branch=" >> $GITHUB_OUTPUT
        fi

    - name: Auto merge PR
      id: auto-merge
      if: steps.create-pr.outputs.pr_created == 'true'
      uses: ./build-workflow/.github/actions/auto-merge-pr
      with:
        repository: ${{ inputs.repository }}
        pr_number: ${{ steps.create-pr.outputs.pr_number }}
        app_id: ${{ inputs.app_id }}
        private_key: ${{ inputs.private_key }}
        owner: ${{ inputs.owner }}

    - name: Delete branch after merge
      id: delete-branch
      if: steps.auto-merge.outputs.merged == 'true'
      uses: ./build-workflow/.github/actions/delete-branch
      with:
        repository: ${{ inputs.repository }}
        branch_name: ${{ steps.create-pr.outputs.pr_branch }}
        app_id: ${{ inputs.app_id }}
        private_key: ${{ inputs.private_key }}
        owner: ${{ inputs.owner }}
