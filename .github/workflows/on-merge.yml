name: On Merge Flow

on:
  workflow_call:
    inputs:
      run_smoke_test:
        description: 'Whether to run the smoke test (set false for base images)'
        type: boolean
        required: false
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare-version:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      build_date: ${{ steps.extract.outputs.build_date }}
      branch: ${{ steps.extract.outputs.branch }}
      sha: ${{ steps.extract.outputs.sha }}
      pr_head_sha_short: ${{ steps.get-pr-sha.outputs.pr_head_sha_short }}
      default_branch: ${{ steps.extract.outputs.default_branch }}
      variants: ${{ steps.extract.outputs.variants }}
      matrix: ${{ steps.extract.outputs.matrix }}
      version_changed: ${{ steps.check-version.outputs.version_changed }}
      pr_images_found: ${{ steps.check-pr-images.outputs.pr_images_found }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Check PR commit and determine if tag is needed
        id: check-pr
        uses: ./build-workflow/.github/actions/check-pr-commit
        with:
          commit_sha: ${{ github.sha }}

      - name: Extract PR head SHA
        id: get-pr-sha
        uses: ./build-workflow/.github/actions/extract-pr-head-sha
        with:
          commit_sha: ${{ github.sha }}

      - name: Extract metadata from VERSION.json
        id: extract
        uses: ./build-workflow/.github/actions/extract-version-metadata

      - name: Check if version changed
        id: check-version
        uses: ./build-workflow/.github/actions/check-version-changed
        with:
          commit_sha: ${{ github.sha }}
          branch: ${{ steps.extract.outputs.branch }}
          default_branch: ${{ steps.extract.outputs.default_branch }}

      - name: Set up Docker and login
        uses: ./build-workflow/.github/actions/docker-setup-login
        with:
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Check if PR images exist
        id: check-pr-images
        uses: ./build-workflow/.github/actions/check-pr-images-exist
        with:
          repository: ${{ github.repository }}
          branch: ${{ steps.extract.outputs.branch }}
          version: ${{ steps.extract.outputs.version }}
          pr_head_sha_short: ${{ steps.get-pr-sha.outputs.pr_head_sha_short }}
          matrix: ${{ steps.extract.outputs.matrix }}

  re-tag:
    needs: prepare-version
    if: needs.prepare-version.outputs.pr_images_found == 'true'
    permissions:
      packages: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ${{ fromJson(needs.prepare-version.outputs.matrix) }}
    steps:
      - name: Checkout build-workflow for actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Set up Docker and login
        uses: ./build-workflow/.github/actions/docker-setup-login
        with:
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Re-tag PR images
        uses: ./build-workflow/.github/actions/retag-pr-images
        with:
          repository: ${{ github.repository }}
          branch: ${{ needs.prepare-version.outputs.branch }}
          version: ${{ needs.prepare-version.outputs.version }}
          target_name: ${{ matrix.target.name }}
          pr_head_sha_short: ${{ needs.prepare-version.outputs.pr_head_sha_short }}

  build-and-test:
    needs: prepare-version
    if: needs.prepare-version.outputs.pr_images_found == 'false'
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ${{ fromJson(needs.prepare-version.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Build, test, and push image
        id: build-test-push
        uses: ./build-workflow/.github/actions/docker-build-test-push
        with:
          arch: ${{ matrix.target.arch }}
          repository: ${{ github.repository }}
          branch: ${{ needs.prepare-version.outputs.branch }}
          version: ${{ needs.prepare-version.outputs.version }}
          target_name: ${{ matrix.target.name }}
          pr_mode: 'false'
          builder_tag: ${{ matrix.target.builder.tag }}
          builder_digest: ${{ matrix.target.builder.digest }}
          base_tag: ${{ matrix.target.base.tag }}
          base_digest: ${{ matrix.target.base.digest }}
          build_date: ${{ needs.prepare-version.outputs.build_date }}
          git_commit: ${{ needs.prepare-version.outputs.sha }}
          package_url: ${{ matrix.target.package_url }}
          dockerfile: ${{ matrix.target.dockerfile }}
          run_smoke_test: ${{ inputs.run_smoke_test && 'true' || 'false' }}
          include_oci_labels: 'true'
          sha: ${{ needs.prepare-version.outputs.sha }}
          server_url: ${{ github.server_url }}
          password: ${{ secrets.GHCR_TOKEN }}

  publish:
    needs: [prepare-version, re-tag, build-and-test]
    if: always() && (needs.re-tag.result == 'success' || needs.build-and-test.result == 'success')
    permissions:
      contents: read
      packages: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout build-workflow for actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          repository: runlix/build-workflow
          path: build-workflow
      
      - name: Set up Docker and login
        uses: ./build-workflow/.github/actions/docker-setup-login
        with:
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Create and push manifest lists
        uses: ./build-workflow/.github/actions/create-manifest-lists
        with:
          variants: ${{ needs.prepare-version.outputs.variants }}
          version: ${{ needs.prepare-version.outputs.version }}
          branch: ${{ needs.prepare-version.outputs.branch }}
          sha: ${{ needs.prepare-version.outputs.sha }}
          repository: ${{ github.repository }}
          matrix: ${{ toJson(fromJson(needs.prepare-version.outputs.matrix)) }}
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.RUNLIX_APP_ID }}
          private-key: ${{ secrets.RUNLIX_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get GitHub App Bot User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
      
      - name: Checkout default branch for tags.json
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          ref: ${{ needs.prepare-version.outputs.default_branch }}
          fetch-depth: 0
          path: repo
          token: ${{ steps.app-token.outputs.token }}

      - name: Update tags.json
        uses: ./build-workflow/.github/actions/update-tags-json
        with:
          run_id: ${{ github.run_id }}
          repository: ${{ github.repository }}
          server_url: ${{ github.server_url }}
          branch: ${{ needs.prepare-version.outputs.branch }}
          pr_base_branch: ${{ needs.prepare-version.outputs.default_branch }}
          version: ${{ needs.prepare-version.outputs.version }}
          sha: ${{ needs.prepare-version.outputs.sha }}
          variants: ${{ needs.prepare-version.outputs.variants }}
          github_token: ${{ steps.app-token.outputs.token }}
          app_bot_name: ${{ steps.app-token.outputs.app-slug }}[bot]
          app_bot_email: ${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com

  create-tag:
    needs: [publish, prepare-version]
    if: success() && needs.prepare-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.RUNLIX_APP_ID }}
          private-key: ${{ secrets.RUNLIX_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          ref: ${{ needs.prepare-version.outputs.sha }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Checkout build-workflow for actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Create git tag
        uses: ./build-workflow/.github/actions/create-git-tag
        with:
          version: ${{ needs.prepare-version.outputs.version }}
          sha: ${{ needs.prepare-version.outputs.sha }}
          repository: ${{ github.repository }}
          github_token: ${{ steps.app-token.outputs.token }}