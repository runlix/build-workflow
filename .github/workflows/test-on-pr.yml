name: Test on PR

on:
  workflow_call:

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      build_date: ${{ steps.extract.outputs.build_date }}
      branch: ${{ steps.extract.outputs.branch }}
      sha: ${{ steps.extract.outputs.sha }}
      default_branch: ${{ steps.extract.outputs.default_branch }}
      variants: ${{ steps.extract.outputs.variants }}
      matrix: ${{ steps.extract.outputs.matrix }}
      test_url: ${{ steps.extract.outputs.test_url }}
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Extract metadata from VERSION.json
        id: extract
        uses: ./build-workflow/.github/actions/extract-version-metadata
        with:
          extract_test_url: 'true'
      
      - name: Debug - Verify extract outputs
        run: |
          # #region agent log
          echo '{"id":"log_'$(date +%s)'_verify","timestamp":'$(date +%s000)',"location":"test-on-pr.yml:35","message":"Checking step extract outputs","data":{"version":"'${{ steps.extract.outputs.version }}'","matrixLength":'$(echo "${{ steps.extract.outputs.matrix }}" | wc -c)',"matrixPreview":"'$(echo "${{ steps.extract.outputs.matrix }}" | head -c 100)'","matrixEmpty":'$(test -z "${{ steps.extract.outputs.matrix }}" && echo "true" || echo "false")'},"sessionId":"debug-session","runId":"run1","hypothesisId":"C,D"}' >> /Users/ohayoun/personal/runlix/.cursor/debug.log
          # #endregion
          echo "DEBUG: Step extract outputs:"
          echo "  version: ${{ steps.extract.outputs.version }}"
          echo "  matrix length: $(echo '${{ steps.extract.outputs.matrix }}' | wc -c) chars"
          echo "  matrix empty: $(test -z '${{ steps.extract.outputs.matrix }}' && echo 'yes' || echo 'no')"
          echo "  matrix preview: $(echo '${{ steps.extract.outputs.matrix }}' | head -c 200)"
          echo "  matrix valid JSON: $(echo '${{ steps.extract.outputs.matrix }}' | jq . >/dev/null 2>&1 && echo 'yes' || echo 'no')"

  test:
    needs: prepare-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ${{ fromJson(needs.prepare-version.outputs.matrix || '[]') }}
    steps:
      - name: Debug - Verify job outputs
        run: |
          # #region agent log
          echo '{"id":"log_'$(date +%s)'_testjob","timestamp":'$(date +%s000)',"location":"test-on-pr.yml:52","message":"Checking prepare-version job outputs in test job","data":{"matrixLength":'$(echo "${{ needs.prepare-version.outputs.matrix }}" | wc -c)',"matrixEmpty":'$(test -z "${{ needs.prepare-version.outputs.matrix }}" && echo "true" || echo "false")',"matrixPreview":"'$(echo "${{ needs.prepare-version.outputs.matrix }}" | head -c 100)'"},"sessionId":"debug-session","runId":"run1","hypothesisId":"C,D"}' >> /Users/ohayoun/personal/runlix/.cursor/debug.log
          # #endregion
          echo "DEBUG: prepare-version job outputs:"
          echo "  matrix length: $(echo '${{ needs.prepare-version.outputs.matrix }}' | wc -c) chars"
          echo "  matrix empty: $(test -z '${{ needs.prepare-version.outputs.matrix }}' && echo 'yes' || echo 'no')"
          echo "  matrix preview: $(echo '${{ needs.prepare-version.outputs.matrix }}' | head -c 200)"
          echo "  matrix valid JSON: $(echo '${{ needs.prepare-version.outputs.matrix }}' | jq . >/dev/null 2>&1 && echo 'yes' || echo 'no')"
          MATRIX_JSON="${{ needs.prepare-version.outputs.matrix }}"
          if [ -z "${MATRIX_JSON}" ]; then
            MATRIX_JSON="[]"
          fi
          echo "  matrix JSON (full): ${MATRIX_JSON}"
          echo "  fromJson result: ${{ fromJson(needs.prepare-version.outputs.matrix || '[]') }}"
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Set up Docker
        uses: ./build-workflow/.github/actions/setup-docker

      - name: Generate metadata
        id: metadata
        uses: ./build-workflow/.github/actions/generate-metadata
        with:
          arch: ${{ matrix.target.arch }}
          repository: ${{ github.repository }}
          branch: ${{ needs.prepare-version.outputs.branch }}
          version: ${{ needs.prepare-version.outputs.version }}
          target_name: ${{ matrix.target.name }}

      - name: Prepare build args
        id: prepare-build-args
        uses: ./build-workflow/.github/actions/prepare-build-args
        with:
          builder_tag: ${{ matrix.target.builder.tag }}
          builder_digest: ${{ matrix.target.builder.digest }}
          base_tag: ${{ matrix.target.base.tag }}
          base_digest: ${{ matrix.target.base.digest }}
          version: ${{ needs.prepare-version.outputs.version }}
          build_date: ${{ needs.prepare-version.outputs.build_date }}
          git_commit: ${{ needs.prepare-version.outputs.sha }}
          package_url: ${{ matrix.target.package_url }}

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.target.dockerfile }}
          platforms: ${{ steps.metadata.outputs.platform }}
          push: false
          load: true
          tags: ${{ steps.metadata.outputs.image-tag }}
          provenance: false
          build-args: ${{ steps.prepare-build-args.outputs.build_args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke Test
        id: smoketest
        uses: ./build-workflow/.github/actions/smoke-test
        with:
          image: ${{ steps.metadata.outputs.image-tag }}
          platform: ${{ steps.metadata.outputs.platform }}
          package_version: ${{ needs.prepare-version.outputs.version }}
          test_url: ${{ needs.prepare-version.outputs.test_url }}

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.target.name }}-${{ needs.prepare-version.outputs.version }}
          path: ${{ needs.prepare-version.outputs.version }}-test.log
          retention-days: 7
