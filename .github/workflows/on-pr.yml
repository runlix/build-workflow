name: On PR Flow

on:
  workflow_call:
    inputs:
      run_smoke_test:
        description: 'Whether to run the smoke test (set false for base images)'
        type: boolean
        required: false
        default: true

permissions:
  contents: read
  pull-requests: write
  packages: write

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      build_date: ${{ steps.extract.outputs.build_date }}
      branch: ${{ steps.extract.outputs.branch }}
      sha: ${{ steps.extract.outputs.sha }}
      sha_short: ${{ steps.extract.outputs.sha_short }}
      target_branch: ${{ steps.get-pr-info.outputs.target_branch }}
      matrix: ${{ steps.extract.outputs.matrix }}
      test_url: ${{ steps.extract.outputs.test_url }}
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Get PR target branch
        id: get-pr-info
        run: |
          if [ -n "${{ github.event.pull_request.base.ref }}" ]; then
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
            echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
            echo "Target branch: ${TARGET_BRANCH}"
          else
            echo "target_branch=" >> $GITHUB_OUTPUT
            echo "Not a PR context, target_branch will be empty"
          fi

      - name: Extract metadata from VERSION.json
        id: extract
        uses: ./build-workflow/.github/actions/extract-version-metadata
        with:
          extract_test_url: 'true'

  test:
    needs: prepare-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ${{ fromJson(needs.prepare-version.outputs.matrix || '[]') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Build, test, and push image
        id: build-test-push
        uses: ./build-workflow/.github/actions/docker-build-test-push
        with:
          arch: ${{ matrix.target.arch }}
          repository: ${{ github.repository }}
          branch: ${{ needs.prepare-version.outputs.target_branch || needs.prepare-version.outputs.branch }}
          version: ${{ needs.prepare-version.outputs.version }}
          target_name: ${{ matrix.target.name }}
          sha_short: ${{ needs.prepare-version.outputs.sha_short }}
          pr_mode: ${{ needs.prepare-version.outputs.target_branch != '' && 'true' || 'false' }}
          builder_tag: ${{ matrix.target.builder.tag }}
          builder_digest: ${{ matrix.target.builder.digest }}
          base_tag: ${{ matrix.target.base.tag }}
          base_digest: ${{ matrix.target.base.digest }}
          build_date: ${{ needs.prepare-version.outputs.build_date }}
          git_commit: ${{ needs.prepare-version.outputs.sha }}
          package_url: ${{ matrix.target.package_url }}
          dockerfile: ${{ matrix.target.dockerfile }}
          run_smoke_test: ${{ inputs.run_smoke_test && 'true' || 'false' }}
          test_url: ${{ needs.prepare-version.outputs.test_url }}
          include_oci_labels: 'false'
          password: ${{ secrets.GHCR_TOKEN }}
 
  test-aggregate:
    name: test-aggregate
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "All matrix tests completed successfully"

  auto-merge:
    needs: test-aggregate
    runs-on: ubuntu-latest
    if: needs.prepare-version.outputs.target_branch != '' && success()
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout build-workflow for actions
        uses: actions/checkout@v6
        with:
          repository: runlix/build-workflow
          path: build-workflow

      - name: Auto merge PR
        id: auto-merge
        uses: ./build-workflow/.github/actions/auto-merge-pr
        with:
          repository: ${{ github.repository }}
          pr_number: ${{ github.event.pull_request.number }}
          app_id: ${{ secrets.RUNLIX_APP_ID }}
          private_key: ${{ secrets.RUNLIX_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
