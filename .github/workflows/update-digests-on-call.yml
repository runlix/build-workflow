name: Update Digests on Call

on:
  workflow_call:
    inputs:
      repository:
        description: 'Target repository (e.g., owner/repo). Defaults to calling repository.'
        required: false
        type: string
      branch:
        description: 'Target branch name. Defaults to calling repository branch.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update digests
        env:
          TARGET_REPO: ${{ inputs.repository || github.repository }}
          TARGET_BRANCH: ${{ inputs.branch || github.ref_name }}
          GH_TOKEN: ${{ secrets.RUNLIX_AUTO }}
        run: |
          set -Eeo pipefail

          # Extract owner and repo name from TARGET_REPO
          OWNER=$(echo "$TARGET_REPO" | cut -d'/' -f1)
          REPO=$(echo "$TARGET_REPO" | cut -d'/' -f2)
          BRANCH="$TARGET_BRANCH"

          echo "üì¶ Processing $OWNER/$REPO:$BRANCH"
          
          DIR=$(mktemp -d)
          git clone --depth 1 -b "$BRANCH" "https://x-access-token:${GH_TOKEN}@github.com/$OWNER/$REPO.git" "$DIR"
          cd "$DIR"

          [[ -x update-digests.sh ]] || { echo "‚è≠ No update-digests.sh script found"; cd ..; rm -rf "$DIR"; exit 0; }
          ./update-digests.sh || { echo "‚ùå Script failed"; cd ..; rm -rf "$DIR"; exit 1; }

          git add .
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚úîÔ∏è No changes detected"
            cd ..; rm -rf "$DIR"; exit 0
          fi

          COMMIT_MSG="Upstream image update"
          [[ "$BRANCH" == "pr" ]] && COMMIT_MSG="Upstream image update [skip ci]"
          
          PR_BRANCH="update-digests-${GITHUB_RUN_ID}-$(date +%s)"
          git checkout -b "${PR_BRANCH}" || { echo "‚ùå Failed to create branch"; cd ..; rm -rf "$DIR"; exit 1; }
          git commit -m "$COMMIT_MSG" || { echo "‚ùå Failed to commit"; cd ..; rm -rf "$DIR"; exit 1; }
          git push -u origin "${PR_BRANCH}" || { echo "‚ùå Failed to push"; cd ..; rm -rf "$DIR"; exit 1; }
          
          gh pr create \
            --repo "$OWNER/$REPO" \
            --title "update-digests" \
            --body "Automated digest update for branch \`${BRANCH}\`" \
            --base "${BRANCH}" \
            --head "${PR_BRANCH}" \
            --label "automated,dependencies" || { echo "‚ö†Ô∏è Failed to create PR (may already exist)"; cd ..; rm -rf "$DIR"; exit 0; }

          cd ..; rm -rf "$DIR"
          echo "‚úÖ Successfully created PR for $OWNER/$REPO:$BRANCH"

