name: update-versions-automated

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  do-work:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: update-versions-automated
      cancel-in-progress: false
    
    steps:
      - name: Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Do Work
        env:
          REPOSITORY_OWNER: runlix
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
        run: |
          set -e
          
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "ERROR: GITHUB_TOKEN is not set"
            exit 1
          fi
          
          echo "Discovering repositories with docker-image topic..."
          REPOS=$(curl -u "${GH_ACTOR}:${GH_TOKEN}" -fsSL "https://api.github.com/users/${REPOSITORY_OWNER}/repos?per_page=1000" 2>&1 | jq -r '.[] | select(.topics[]?=="docker-image") | .name' || echo "")
          
          if [ -z "$REPOS" ]; then
            echo "WARNING: No repositories found with docker-image topic"
            echo "Debug: Listing all repos to verify API call works..."
            curl -u "${GH_ACTOR}:${GH_TOKEN}" -fsSL "https://api.github.com/users/${REPOSITORY_OWNER}/repos?per_page=1000" 2>&1 | jq -r '.[] | "\(.name) - topics: \(.topics | join(", "))"' || echo "API call failed"
            exit 0
          fi
          
          echo "Found repositories:"
          echo "$REPOS"
          
          while IFS= read -r REPOSITORY; do
            [ -z "$REPOSITORY" ] && continue
            
            echo "Processing repository: ${REPOSITORY_OWNER}/${REPOSITORY}"
            
            echo "Fetching branches for ${REPOSITORY}..."
            BRANCHES=$(curl -u "${GH_ACTOR}:${GH_TOKEN}" -fsSL "https://api.github.com/repos/${REPOSITORY_OWNER}/${REPOSITORY}/branches" 2>&1 | jq -r '.[] | select(.name!="main" and .name!="master") | .name' || echo "")
            
            if [ -z "$BRANCHES" ]; then
              echo "WARNING: No branches found (excluding main/master) for ${REPOSITORY}"
              echo "Debug: Listing all branches..."
              curl -u "${GH_ACTOR}:${GH_TOKEN}" -fsSL "https://api.github.com/repos/${REPOSITORY_OWNER}/${REPOSITORY}/branches" 2>&1 | jq -r '.[] | .name' || echo "Failed to fetch branches"
              continue
            fi
            
            echo "Found branches for ${REPOSITORY}:"
            echo "$BRANCHES"
            
            while IFS= read -r BRANCH; do
              [ -z "$BRANCH" ] && continue
              
              echo "Processing branch: ${REPOSITORY_OWNER}/${REPOSITORY}:${BRANCH}"
              
              CLONE_DIR=$(mktemp -d)
              
              # Clone without token first (for public repos), then configure remote with token for push
              if ! git clone -b "${BRANCH}" "https://github.com/${REPOSITORY_OWNER}/${REPOSITORY}.git" "${CLONE_DIR}" 2>/dev/null; then
                # If public clone fails, try with token (for private repos)
                if ! git clone -b "${BRANCH}" "https://${GH_TOKEN}@github.com/${REPOSITORY_OWNER}/${REPOSITORY}.git" "${CLONE_DIR}" 2>/dev/null; then
                  echo "Failed to clone ${REPOSITORY}:${BRANCH}"
                  rm -rf "${CLONE_DIR}"
                  continue
                fi
              fi
              
              cd "${CLONE_DIR}" || { rm -rf "${CLONE_DIR}"; continue; }
              
              # Configure remote with token for push operations (set once)
              git remote set-url origin "https://${GH_TOKEN}@github.com/${REPOSITORY_OWNER}/${REPOSITORY}.git" 2>/dev/null || true
              
              if [ ! -f update-versions.sh ]; then
                echo "No update-versions.sh found in ${REPOSITORY}:${BRANCH}, skipping"
                cd .. || exit 1
                rm -rf "${CLONE_DIR}"
                continue
              fi
              
              echo "Executing update-versions.sh for ${REPOSITORY}:${BRANCH}..."
              bash ./update-versions.sh || { echo "Script failed or no changes for ${REPOSITORY}:${BRANCH}"; cd .. || exit 1; rm -rf "${CLONE_DIR}"; continue; }
              
              COMMIT_MESSAGE="Version update"
              [ "${BRANCH}" = "pr" ] && COMMIT_MESSAGE="Version update [skip ci]"
              
              git add .
              
              if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "Changes detected for ${REPOSITORY}:${BRANCH}"
                PR_BRANCH="update-versions-${GITHUB_RUN_ID}-$(date +%s)"
                git checkout -b "${PR_BRANCH}" || { cd .. || exit 1; rm -rf "${CLONE_DIR}"; continue; }
                git commit -m "${COMMIT_MESSAGE}" || { cd .. || exit 1; rm -rf "${CLONE_DIR}"; continue; }
                git push -u origin "${PR_BRANCH}" || { cd .. || exit 1; rm -rf "${CLONE_DIR}"; continue; }
                
                gh pr create \
                  --repo "${REPOSITORY_OWNER}/${REPOSITORY}" \
                  --title "Version update" \
                  --body "Automated version update for branch \`${BRANCH}\`" \
                  --base "${BRANCH}" \
                  --head "${PR_BRANCH}" \
                  --label "automated,dependencies" || true
              else
                echo "No changes detected for ${REPOSITORY}:${BRANCH}"
              fi
              
              cd .. || exit 1
              rm -rf "${CLONE_DIR}"
            done <<< "$BRANCHES"
          done <<< "$REPOS"
          
          echo "Completed processing all repositories"

