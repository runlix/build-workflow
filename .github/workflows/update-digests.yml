name: update-digests-automated

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: update-digests-automated
      cancel-in-progress: false

    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Update digests across repositories
        env:
          OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeo pipefail

          echo "üîç Discovering repositories with docker-image topic..."
          REPOSITORIES=$(gh repo list "$OWNER" --limit 200 --json name,repositoryTopics --jq '.[] | select([.repositoryTopics[]?.name] | index("docker-image")) | .name')
          
          echo "üîç Found repositories: $REPOSITORIES"
          for REPO in $REPOSITORIES; do
            echo "üì¶ Processing $OWNER/$REPO"

            gh api "/repos/$OWNER/$REPO/branches" \
              --jq '.[] | select(.name!="main" and .name!="master") | .name' |
            while read -r BRANCH; do
              echo "‚û°Ô∏è Branch $BRANCH"
              
              DIR=$(mktemp -d)
              git clone --depth 1 -b "$BRANCH" "https://${GH_TOKEN}@github.com/$OWNER/$REPO.git" "$DIR"
              cd "$DIR"

              [[ -x update-digests.sh ]] || { echo "‚è≠ No script"; cd ..; rm -rf "$DIR"; continue; }
              ./update-digests.sh || { echo "‚ùå Script failed"; cd ..; rm -rf "$DIR"; continue; }

              git add .
              # Check if there are changes to commit
              if git diff --cached --quiet; then
                echo "‚úîÔ∏è No changes"
                cd ..; rm -rf "$DIR"; continue
              fi

              COMMIT_MSG="Upstream image update"
              [[ "$BRANCH" == "pr" ]] && COMMIT_MSG="Upstream image update [skip ci]"
              
              git commit -m "$COMMIT_MSG"
              git push

              cd ..; rm -rf "$DIR"
            done
          done
