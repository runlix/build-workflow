name: update-digests-automated

description: Automated workflow that discovers and processes all repositories with docker-image topic, executing update-digests.sh scripts and creating pull requests when changes are detected.

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  do-work:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: update-digests-automated
      cancel-in-progress: false
    
    steps:
      - name: Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Do Work
        env:
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_TERMINAL_PROMPT: 0
        run: |
          set -euo pipefail
          
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "ERROR: GITHUB_TOKEN is not set"
            exit 1
          fi
          
          # #region agent log
          DEBUG_LOG="${GITHUB_WORKSPACE:-/tmp}/debug.log"
          echo "DEBUG: Testing credential helper vs URL token approach" | tee -a "$DEBUG_LOG"
          # #endregion
          
          # Remove credential helper - use URL token approach like update-versions.yml
          git config --global --unset credential.helper 2>/dev/null || true
          
          # #region agent log
          echo "DEBUG: Credential helper removed - will use URL token only" | tee -a "$DEBUG_LOG"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"update-digests.yml:41\",\"message\":\"Credential helper removed\",\"data\":{\"hasToken\":\"${GH_TOKEN:+yes}\",\"tokenLength\":${#GH_TOKEN},\"credentialHelper\":\"$(git config --global credential.helper || echo 'none')\"},\"sessionId\":\"debug-session\",\"runId\":\"run2\",\"hypothesisId\":\"F\"}" | tee -a "$DEBUG_LOG"
          # #endregion
          
          # Cleanup function for temporary directories
          cleanup() {
            if [ -n "${CLONE_DIR:-}" ] && [ -d "${CLONE_DIR}" ]; then
              rm -rf "${CLONE_DIR}"
            fi
          }
          trap cleanup EXIT
          
          echo "Discovering repositories with docker-image topic..."
          REPOS=$(gh api "/users/${REPOSITORY_OWNER}/repos?per_page=100" --jq '.[] | select(.topics[]?=="docker-image") | .name' || echo "")
          
          if [ -z "$REPOS" ]; then
            echo "WARNING: No repositories found with docker-image topic"
            exit 0
          fi
          
          echo "Found repositories:"
          echo "$REPOS"
          
          # Initialize counters
          PROCESSED=0
          FAILED=0
          PRS_CREATED=0
          
          while IFS= read -r REPOSITORY; do
            [ -z "$REPOSITORY" ] && continue
            
            echo "Processing repository: ${REPOSITORY_OWNER}/${REPOSITORY}"
            
            echo "Fetching branches for ${REPOSITORY}..."
            BRANCHES=$(gh api "/repos/${REPOSITORY_OWNER}/${REPOSITORY}/branches" --jq '.[] | select(.name!="main" and .name!="master") | .name' || echo "")
            
            if [ -z "$BRANCHES" ]; then
              echo "WARNING: No branches found (excluding main/master) for ${REPOSITORY}"
              continue
            fi
            
            echo "Found branches for ${REPOSITORY}:"
            echo "$BRANCHES"
            
            while IFS= read -r BRANCH; do
              [ -z "$BRANCH" ] && continue
              
              echo "Processing branch: ${REPOSITORY_OWNER}/${REPOSITORY}:${BRANCH}"
              
              CLONE_DIR=$(mktemp -d)
              
              # Clone using credential helper (token handled via environment variable)
              if ! git clone -b "${BRANCH}" "https://github.com/${REPOSITORY_OWNER}/${REPOSITORY}.git" "${CLONE_DIR}" 2>/dev/null; then
                echo "Failed to clone ${REPOSITORY}:${BRANCH}"
                FAILED=$((FAILED + 1))
                rm -rf "${CLONE_DIR}"
                continue
              fi
              
              if ! cd "${CLONE_DIR}"; then
                echo "Failed to change directory for ${REPOSITORY}:${BRANCH}"
                FAILED=$((FAILED + 1))
                rm -rf "${CLONE_DIR}"
                continue
              fi
              
              # Configure remote with token for push operations (set once)
              git remote set-url origin "https://${GH_TOKEN}@github.com/${REPOSITORY_OWNER}/${REPOSITORY}.git" 2>/dev/null || true
              
              # #region agent log
              DEBUG_LOG="${GITHUB_WORKSPACE:-/tmp}/debug.log"
              REMOTE_URL=$(git remote get-url origin)
              HAS_TOKEN=$(echo "$REMOTE_URL" | grep -q '@' && echo "yes" || echo "no")
              # Test token permissions by checking repo access
              TOKEN_TEST=$(gh api "/repos/${REPOSITORY_OWNER}/${REPOSITORY}" --jq '.permissions.push // false' 2>/dev/null || echo "unknown")
              echo "DEBUG: Remote URL configured - repo=${REPOSITORY}, branch=${BRANCH}, remoteUrl=${REMOTE_URL}, hasTokenInUrl=${HAS_TOKEN}, tokenHasPushPermission=${TOKEN_TEST}" | tee -a "$DEBUG_LOG"
              echo "{\"timestamp\":$(date +%s000),\"location\":\"update-digests.yml:110\",\"message\":\"Remote URL configured\",\"data\":{\"repo\":\"${REPOSITORY}\",\"branch\":\"${BRANCH}\",\"remoteUrl\":\"${REMOTE_URL}\",\"hasTokenInUrl\":\"${HAS_TOKEN}\",\"tokenHasPushPermission\":\"${TOKEN_TEST}\"},\"sessionId\":\"debug-session\",\"runId\":\"run2\",\"hypothesisId\":\"G\"}" | tee -a "$DEBUG_LOG"
              # #endregion
              
              if [ ! -f update-digests.sh ]; then
                echo "No update-digests.sh found in ${REPOSITORY}:${BRANCH}, skipping"
                cd .. || true
                rm -rf "${CLONE_DIR}"
                continue
              fi
              
              # Ensure script is executable
              [ ! -x update-digests.sh ] && chmod +x update-digests.sh
              
              echo "Executing update-digests.sh for ${REPOSITORY}:${BRANCH}..."
              if ! bash ./update-digests.sh; then
                echo "Script failed for ${REPOSITORY}:${BRANCH}"
                FAILED=$((FAILED + 1))
                cd .. || true
                rm -rf "${CLONE_DIR}"
                continue
              fi
              
              COMMIT_MESSAGE="Upstream image update"
              [ "${BRANCH}" = "pr" ] && COMMIT_MESSAGE="Upstream image update [skip ci]"
              
              git add .
              
              if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "Changes detected for ${REPOSITORY}:${BRANCH}"
                PR_BRANCH="update-digests-${GITHUB_RUN_ID}-$(date +%s)"
                
                if ! git checkout -b "${PR_BRANCH}"; then
                  echo "Failed to create branch for ${REPOSITORY}:${BRANCH}"
                  FAILED=$((FAILED + 1))
                  cd .. || true
                  rm -rf "${CLONE_DIR}"
                  continue
                fi
                
                if ! git commit -m "${COMMIT_MESSAGE}"; then
                  echo "Failed to commit for ${REPOSITORY}:${BRANCH}"
                  FAILED=$((FAILED + 1))
                  cd .. || true
                  rm -rf "${CLONE_DIR}"
                  continue
                fi
                
                # #region agent log
                DEBUG_LOG="${GITHUB_WORKSPACE:-/tmp}/debug.log"
                REMOTE_URL=$(git remote get-url origin)
                CRED_HELPER=$(git config --global credential.helper)
                echo "DEBUG: Before push - repo=${REPOSITORY}, branch=${BRANCH}, prBranch=${PR_BRANCH}, remoteUrl=${REMOTE_URL}" | tee -a "$DEBUG_LOG"
                echo "DEBUG: Credential helper: ${CRED_HELPER}" | tee -a "$DEBUG_LOG"
                echo "{\"timestamp\":$(date +%s000),\"location\":\"update-digests.yml:160\",\"message\":\"Before push attempt\",\"data\":{\"repo\":\"${REPOSITORY}\",\"branch\":\"${BRANCH}\",\"prBranch\":\"${PR_BRANCH}\",\"remoteUrl\":\"${REMOTE_URL}\",\"credentialHelper\":\"${CRED_HELPER}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\"}" | tee -a "$DEBUG_LOG"
                # #endregion
                
                PUSH_OUTPUT=$(mktemp)
                if ! git push -u origin "${PR_BRANCH}" 2>&1 | tee "$PUSH_OUTPUT"; then
                  # #region agent log
                  PUSH_ERROR=$(head -5 "$PUSH_OUTPUT" | tr '\n' ' ')
                  echo "DEBUG: Push failed - repo=${REPOSITORY}, branch=${BRANCH}, error=${PUSH_ERROR}" | tee -a "$DEBUG_LOG"
                  echo "{\"timestamp\":$(date +%s000),\"location\":\"update-digests.yml:164\",\"message\":\"Push failed\",\"data\":{\"repo\":\"${REPOSITORY}\",\"branch\":\"${BRANCH}\",\"error\":\"${PUSH_ERROR}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"D\"}" | tee -a "$DEBUG_LOG"
                  # #endregion
                  echo "Failed to push for ${REPOSITORY}:${BRANCH}"
                  FAILED=$((FAILED + 1))
                  rm -f "$PUSH_OUTPUT"
                  cd .. || true
                  rm -rf "${CLONE_DIR}"
                  continue
                fi
                rm -f "$PUSH_OUTPUT"
                
                # #region agent log
                echo "DEBUG: Push succeeded - repo=${REPOSITORY}, branch=${BRANCH}" | tee -a "$DEBUG_LOG"
                echo "{\"timestamp\":$(date +%s000),\"location\":\"update-digests.yml:164\",\"message\":\"Push succeeded\",\"data\":{\"repo\":\"${REPOSITORY}\",\"branch\":\"${BRANCH}\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"E\"}" | tee -a "$DEBUG_LOG"
                # #endregion
                
                if gh pr create \
                  --repo "${REPOSITORY_OWNER}/${REPOSITORY}" \
                  --title "Upstream image update" \
                  --body "Automated upstream image digest update for branch \`${BRANCH}\`" \
                  --base "${BRANCH}" \
                  --head "${PR_BRANCH}" \
                  --label automated \
                  --label dependencies 2>/dev/null; then
                  PRS_CREATED=$((PRS_CREATED + 1))
                  echo "Created PR for ${REPOSITORY}:${BRANCH}"
                else
                  echo "Failed to create PR for ${REPOSITORY}:${BRANCH}"
                  FAILED=$((FAILED + 1))
                fi
              else
                echo "No changes detected for ${REPOSITORY}:${BRANCH}"
              fi
              
              PROCESSED=$((PROCESSED + 1))
              cd .. || true
              rm -rf "${CLONE_DIR}"
            done <<< "$BRANCHES"
          done <<< "$REPOS"
          
          echo "Completed processing all repositories"
          echo "Summary: Processed=${PROCESSED}, PRs Created=${PRS_CREATED}, Failed=${FAILED}"
          [ $FAILED -gt 0 ] && exit 1
