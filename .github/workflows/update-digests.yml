name: update-digests-automated

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: update-digests-automated
      cancel-in-progress: false

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.RUNLIX_APP_ID }}
          private-key: ${{ secrets.RUNLIX_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get GitHub App Bot User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Update digests across repositories
        env:
          OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -Eeo pipefail

          echo "üîç Discovering repositories with docker-image topic..."
          REPOSITORIES=$(gh repo list "$OWNER" --limit 200 --json name,repositoryTopics --jq '.[] | select([.repositoryTopics[]?.name] | index("docker-image")) | .name')
          
          echo "üîç Found repositories: $REPOSITORIES"
          for REPO in $REPOSITORIES; do
            echo "üì¶ Processing $OWNER/$REPO"

            gh api "/repos/$OWNER/$REPO/branches" \
              --jq '.[] | select(.name!="main" and .name!="master") | .name' |
            while read -r BRANCH; do
              echo "‚û°Ô∏è Branch $BRANCH"
              
              DIR=$(mktemp -d)
              # git clone --depth 1 -b "$BRANCH" "https://${GH_TOKEN}@github.com/$OWNER/$REPO.git" "$DIR"
              git clone --depth 1 -b "$BRANCH" "https://x-access-token:${GH_TOKEN}@github.com/$OWNER/$REPO.git" "$DIR"
              cd "$DIR"

              [[ -x update-digests.sh ]] || { echo "‚è≠ No script"; cd ..; rm -rf "$DIR"; continue; }
              ./update-digests.sh || { echo "‚ùå Script failed"; cd ..; rm -rf "$DIR"; continue; }

              git add .
              # Check if there are changes to commit
              if git diff --cached --quiet; then
                echo "‚úîÔ∏è No changes"
                cd ..; rm -rf "$DIR"; continue
              fi

              COMMIT_MSG="Upstream image update"
              [[ "$BRANCH" == "pr" ]] && COMMIT_MSG="Upstream image update [skip ci]"
              
              PR_BRANCH="update-digests-${GITHUB_RUN_ID}-$(date +%s)"
              git checkout -b "${PR_BRANCH}" || { echo "‚ùå Failed to create branch"; cd ..; rm -rf "$DIR"; continue; }
              git commit -m "$COMMIT_MSG" || { echo "‚ùå Failed to commit"; cd ..; rm -rf "$DIR"; continue; }
              git push -u origin "${PR_BRANCH}" || { echo "‚ùå Failed to push"; cd ..; rm -rf "$DIR"; continue; }
              
              gh pr create \
                --repo "$OWNER/$REPO" \
                --title "update-digests" \
                --body "Automated digest update for branch \`${BRANCH}\`" \
                --base "${BRANCH}" \
                --head "${PR_BRANCH}" \
                --label "automated,dependencies" || true

              cd ..; rm -rf "$DIR"
            done
          done
