name: update-digests-automated

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: read
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: update-digests-automated
      cancel-in-progress: false

    steps:
      - name: Configure Git + Auth
        env:
          GH_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -e
          gh auth setup-git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update digests across repositories
        env:
          OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -Eeo pipefail

          echo "üîç Discovering repositories with docker-image topic..."
          REPOSITORIES=$(gh repo list runlix --limit 200 --json name,repositoryTopics --jq '.[] | select([.repositoryTopics[]?.name] | index("docker-image")) | .name')
          
          echo "üîç Found repositories: $REPOSITORIES"
          for REPO in $REPOSITORIES; do
            echo "üì¶ Processing $OWNER/$REPO"

            gh api "/repos/$OWNER/$REPO/branches" \
              --jq '.[] | select(.name!="main" and .name!="master") | .name' |
            while read -r BRANCH; do
              [[ "$BRANCH" == update-digests-* ]] && { echo "‚è≠ Skipping branch $BRANCH (starts with update-digests-)"; continue; }
              echo "‚û°Ô∏è Branch $BRANCH"
              
              DIR=$(mktemp -d)
              git clone --depth 1 -b "$BRANCH" "https://github.com/$OWNER/$REPO.git" "$DIR"
              cd "$DIR"

              [[ -x update-digests.sh ]] || { echo "‚è≠ No script"; cd ..; rm -rf "$DIR"; continue; }
              ./update-digests.sh || { echo "‚ùå Script failed"; cd ..; rm -rf "$DIR"; continue; }

              # Detect staged or unstaged changes
              if git diff-index --quiet HEAD; then
                echo "‚úîÔ∏è No changes"
                cd ..; rm -rf "$DIR"; continue
              fi

              PR_BRANCH="update-digests-${GITHUB_RUN_ID}-$(date +%s)"
              COMMIT_MSG="Upstream image update"
              
              git checkout -b "$PR_BRANCH"
              git add .
              # abort if nothing is staged
              if git diff --cached --quiet; then
                echo "‚úîÔ∏è No staged changes, skipping PR"
                cd ..; rm -rf "$DIR"; continue
              fi
              git commit -m "$COMMIT_MSG"
              git push --set-upstream origin "$PR_BRANCH"

              gh pr create \
                --repo "$OWNER/$REPO" \
                --title "$COMMIT_MSG" \
                --body "Automated upstream image digest update for \`$BRANCH\`" \
                --base "$BRANCH" --head "$PR_BRANCH" \

              cd ..; rm -rf "$DIR"
            done
          done
