# Test Dockerfile for service - AMD64
# Demonstrates auto-injection of BASE_IMAGE, BASE_TAG, BASE_DIGEST
# NOTE: Distroless images can only run static binaries, not shell scripts

# These build args are auto-injected by the workflow
# DO NOT manually add them to docker-matrix.json build_args
ARG BASE_IMAGE
ARG BASE_TAG
ARG BASE_DIGEST

# Application-specific build args (defined in docker-matrix.json)
ARG APP_VERSION
ARG APP_USER
ARG APP_PORT

FROM ${BASE_IMAGE}:${BASE_TAG}@${BASE_DIGEST}

# Add metadata file with build information
# This is the only thing we can reliably add to distroless
COPY --chmod=0644 <<EOF /app/metadata.json
{
  "app_version": "${APP_VERSION}",
  "arch": "amd64",
  "user": "${APP_USER}",
  "port": "${APP_PORT}",
  "base_image": "${BASE_IMAGE}",
  "base_tag": "${BASE_TAG}",
  "base_digest": "${BASE_DIGEST}",
  "variant": "standard"
}
EOF

# EXPOSE does not support variable expansion - must use literal port
# In real usage, you would expose the actual port your app uses
EXPOSE 8080

# USER does not support variable expansion and distroless only has root and nonroot users
# For production, you should use nonroot: USER 65532:65532
# For this test, we use root (default)

# Distroless images have no shell or entrypoint by default
# In real usage, you would COPY your compiled binary and set it as ENTRYPOINT
# For testing purposes, we don't set an entrypoint (container will exit immediately)
